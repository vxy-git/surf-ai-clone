# 🔧 LunarCrush API 修复说明

## 🐛 问题描述

### 症状
当询问 "What's the sentiment for Bitcoin?" 时,返回的是模拟数据而非真实的 LunarCrush 数据。

### 错误日志
```
Social sentiment API error: Error: fetch failed
at context.fetch (.../next/dist/server/web/sandbox/context.js:321:60)
```

### 根本原因
**Next.js Edge Runtime 的限制**

Edge Runtime 运行在受限的沙箱环境中,对某些外部 API 的 fetch 请求有限制,导致 LunarCrush API 调用失败。

---

## ✅ 解决方案

### 修改内容

#### 1. `src/app/api/chat/route.ts`
```typescript
// 之前
export const runtime = 'edge';

// 之后 (已注释)
// export const runtime = 'edge';
```

#### 2. `src/app/api/research/route.ts`
```typescript
// 之前
export const runtime = 'edge';

// 之后 (已注释)
// export const runtime = 'edge';
```

### 效果
- ✅ 改用 Node.js Runtime
- ✅ 支持完整的网络请求
- ✅ LunarCrush API 可以正常调用
- ✅ Etherscan API 可以正常调用

---

## 🎯 如何验证修复

### 步骤 1: 重启服务器
```bash
# 如果服务器还在运行,按 Ctrl+C 停止
# 然后重新启动
pnpm dev
```

### 步骤 2: 测试 LunarCrush API
在聊天界面输入:
```
What's the sentiment for Bitcoin?
```

### 步骤 3: 查看返回结果

#### ✅ 成功的标志 (真实数据):
```
数据来源: LunarCrush API (Real-time)
社交量: 15,234
社交主导度: 12.5%
Galaxy Score: 72.3
Alt Rank: 8
```

#### ❌ 失败的标志 (模拟数据):
```
KOL: CryptoWhale (500K 粉丝)
KOL: BlockchainAnalyst (350K 粉丝)
数据来源: Simulated Data
```

### 步骤 4: 查看服务器日志
如果看到类似的日志,说明成功:
```
✓ LunarCrush API called successfully
✓ Data received for BTC
```

如果看到错误,说明还有问题:
```
Social sentiment API error: ...
```

---

## 🔍 可能的其他问题

### 问题 1: API Key 无效

**症状**: 仍然返回模拟数据,但没有 "fetch failed" 错误

**日志**:
```
LunarCrush API error: 401
或
LunarCrush API error: 403
```

**解决方案**:
1. 检查 `.env` 文件中的 `LUNARCRUSH_API_KEY`
2. 确认 Key 没有过期
3. 访问 https://lunarcrush.com/developers/api 确认 Key 状态

### 问题 2: API 配额用尽

**症状**: 返回 429 错误

**日志**:
```
LunarCrush API error: 429 (Too Many Requests)
```

**解决方案**:
1. 等待配额重置
2. 升级 LunarCrush 套餐
3. 添加请求缓存

### 问题 3: 网络连接问题

**症状**: 间歇性失败

**解决方案**:
1. 检查网络连接
2. 检查防火墙设置
3. 尝试使用代理

---

## 📊 Runtime 对比

### Edge Runtime
**优点**:
- ⚡ 更快的冷启动
- 🌍 部署到边缘节点
- 💰 更便宜(某些平台)

**缺点**:
- ❌ 受限的 API (某些 fetch 被限制)
- ❌ 不支持 Node.js 特定功能
- ❌ 对复杂的外部 API 调用支持不好

### Node.js Runtime (当前使用)
**优点**:
- ✅ 完整的 Node.js 功能
- ✅ 无限制的网络请求
- ✅ 更好的兼容性
- ✅ 支持所有外部 API

**缺点**:
- ⚠️ 稍慢的冷启动(影响很小)
- ⚠️ 不在边缘节点(但对这个项目影响不大)

### 为什么选择 Node.js Runtime?

对于这个项目:
- 需要调用多个外部 API (LunarCrush, Etherscan, CoinGecko)
- 复杂的数据处理
- AI 工具链需要完整的网络功能

**Node.js Runtime 更合适!**

---

## 🎉 预期结果

修复后,当您问 "What's the sentiment for Bitcoin?" 时:

### 真实数据示例
```
目前 BTC 的社交情绪分析

数据来源: LunarCrush API (Real-time)

整体情绪: 看涨
情绪评分: 65.30 (基于真实社交媒体数据)

看涨比例: 64.2%
看跌比例: 35.8%

社交指标:
- 社交量: 15,234 帖子
- 社交参与度: 8,456 贡献者
- 社交主导度: 12.5%
- Alt Rank: 8

价格相关性:
- Galaxy Score: 72.3
- 波动率: 2.45

主要讨论主题:
- 社交量趋势
- 社区参与分析
- 价格相关讨论
- 市场情绪转变

热门标签: #BTC #crypto #blockchain

时间戳: 2025-10-23T20:00:00.000Z
```

---

## 🔧 如果还是不行

### 调试步骤

1. **检查环境变量**
```bash
# 确认 .env 文件存在
ls -la .env

# 查看内容 (隐藏敏感信息)
cat .env | grep LUNARCRUSH
```

2. **手动测试 API**
```bash
# 使用 curl 测试
curl "https://api.lunarcrush.com/v2?data=assets&key=YOUR_KEY&symbol=BTC"
```

3. **查看完整错误**
在 `src/lib/ai-tools.ts` 的 `socialSentimentTool` 中添加更详细的日志:
```typescript
} catch (error) {
  console.error('Social sentiment API error:', error);
  console.error('Error details:', JSON.stringify(error, null, 2)); // 添加这行
  // ...
}
```

4. **测试其他 API**
```
# 测试 Etherscan (应该工作)
"Show me Ethereum's on-chain data"

# 测试 CoinGecko (应该工作)
"What's the price of Bitcoin?"
```

---

## 📝 总结

### 修改内容
- 注释掉了 `export const runtime = 'edge';`
- 改用 Node.js Runtime

### 预期效果
- ✅ LunarCrush API 正常调用
- ✅ 返回真实的社交情绪数据
- ✅ 所有 5 个 AI 工具都使用真实数据

### 验证方法
- 重启服务器
- 提问并查看返回数据
- 检查是否包含 "LunarCrush API (Real-time)"

---

**现在请重新测试,应该可以看到真实数据了!** 🎉
